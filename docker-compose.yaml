services:
  # PHP-FPM сервис для Laravel
  backend:
    build:
      context: .
      dockerfile: docker/backend/Dockerfile
    container_name: trainer_backend
    restart: unless-stopped
    working_dir: /var/www/trainer/backend
    volumes:
      - ./backend:/var/www/trainer/backend
      - ./docker/backend/php.ini:/usr/local/etc/php/conf.d/custom.ini
    networks:
      - trainer_network
    depends_on:
      - mysql
      - redis
    environment:
      - DB_CONNECTION=mysql
      - DB_HOST=mysql
      - DB_PORT=${MYSQL_INNER_PORT:-3306}
      - DB_DATABASE=${MYSQL_DATABASE:-trainer_db}
      - DB_USERNAME=${MYSQL_USERNAME:-trainer_user}
      - DB_PASSWORD=${MYSQL_PASSWORD:-REPLACE_IN_PROD}
      - APP_NAME=${LARAVEL_APP_NAME:-Trainer}
      - APP_ENV=${LARAVEL_APP_ENV:-local} #REPLACE_IN_PROD
      - APP_KEY=${LARAVEL_APP_KEY:-base64:B0IU2BoOm2lqBuxVeKPIfabGlNH74go7jwsl3MnJGtc=} #REPLACE_IN_PROD
      - APP_DEBUG=${LARAVEL_APP_DEBUG:-true} #REPLACE_IN_PROD
      - APP_URL=${LARAVEL_APP_URL:-http://localhost} #REPLACE_IN_PROD

      - APP_LOCALE=${LARAVEL_APP_LOCALE:-en}
      - APP_FALLBACK_LOCALE=${LARAVEL_APP_FALLBACK_LOCALE:-en}
      - APP_FAKER_LOCALE=${LARAVEL_APP_FAKER_LOCALE:-en_US}

      - APP_MAINTENANCE_DRIVER=${LARAVEL_APP_MAINTENANCE_DRIVER:-false}
      - BCRYPT_ROUNDS=${LARAVEL_BCRYPT_ROUNDS:-12}

      - LOG_CHANNEL=${LARAVEL_LOG_CHANNEL:-stack}
      - LOG_STACK=${LARAVEL_LOG_STACK:-single}
      - LOG_DEPRECATIONS_CHANNEL=${LARAVEL_LOG_DEPRECATIONS_CHANNEL:-null}
      - LOG_LEVEL=${LARAVEL_LOG_LEVEL:-debug}
      - SESSION_DRIVER=${LARAVEL_SESSION_DRIVER:-database}
      - SESSION_LIFETIME=${LARAVEL_SESSION_LIFETIME:-120}
      - SESSION_ENCRYPT=${LARAVEL_SESSION_ENCRYPT:-false}
      - SESSION_PATH=${LARAVEL_SESSION_PATH:-/}
      - SESSION_DOMAIN=${LARAVEL_SESSION_DOMAIN:-null}

      - BROADCAST_CONNECTION=${LARAVEL_BROADCAST_CONNECTION:-log}
      - FILESYSTEM_DISK=${LARAVEL_FILESYSTEM_DISK:-local}
      - QUEUE_CONNECTION=${LARAVEL_QUEUE_CONNECTION:-redis}

      - CACHE_STORE=${LARAVEL_CACHE_STORE:-redis}
      - CACHE_PREFIX=${LARAVEL_CACHE_PREFIX:-laravel_cache_}

      - REDIS_CLIENT=${LARAVEL_REDIS_CLIENT:-phpredis}
      - REDIS_HOST=${REDIS_INNER_HOST:-redis}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-null} #REPLACE_IN_PROD
      - REDIS_PORT=${REDIS_INNER_PORT:-6379}

  # MySQL база данных
  mysql:
    image: mysql:9.5
    container_name: trainer_mysql
    restart: unless-stopped
    ports:
      - "${MYSQL_HOST_PORT:-3306}:${MYSQL_INNER_PORT:-3306}"
    environment:
      MYSQL_DATABASE: ${MYSQL_DATABASE:-trainer_db}
      MYSQL_USER: ${MYSQL_USERNAME:-trainer_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-REPLACE_IN_PROD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-REPLACE_IN_PROD}
    volumes:
      - ./docker/mysql/data:/var/lib/mysql
    networks:
      - trainer_network

  # Nginx веб-сервер
  nginx:
    image: nginx:1.29-alpine
    container_name: trainer_nginx
    restart: unless-stopped
    ports:
      - "${NGINX_HOST_PORT:-80}:${NGINX_INNER_PORT:-80}"
    volumes:
      - ./backend:/var/www/trainer/backend
      - ./docker/nginx/nginx.conf:/etc/nginx/conf.d/default.conf
    networks:
      - trainer_network
    depends_on:
      - backend

  # Redis для очередей и кеширования
  redis:
    image: redis:8.4-alpine
    container_name: trainer_redis
    restart: unless-stopped
    ports:
      - "${REDIS_HOST_PORT:-6379}:${REDIS_INNER_PORT:-6379}"
    command: >
      sh -c "if [ -n \"$$REDIS_PASSWORD\" ] && [ \"$$REDIS_PASSWORD\" != \"null\" ]; then
        redis-server --requirepass $$REDIS_PASSWORD;
      else
        redis-server;
      fi"
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
    volumes:
      - redis_data:/data
    networks:
      - trainer_network

  # phpMyAdmin для управления БД
  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    container_name: trainer_phpmyadmin
    restart: unless-stopped
    ports:
      - "${PHPMYADMIN_HOST_PORT:-8080}:${PHPMYADMIN_INNER_PORT:-80}"
    environment:
      PMA_HOST: ${MYSQL_INNER_HOST:-mysql}
      PMA_PORT: ${MYSQL_INNER_PORT:-3306}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-REPLACE_IN_PROD}
    networks:
      - trainer_network
    depends_on:
      - mysql

volumes:
  redis_data:
    driver: local

networks:
  trainer_network:
    driver: bridge
